<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PassPortier - Parolni Tahrirlash</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #1a1a2e);
            color: var(--tg-theme-text-color, #eee);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
        }

        h2 {
            text-align: center;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--tg-theme-hint-color, #888);
            font-size: 14px;
        }

        input,
        textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid transparent;
            border-radius: 12px;
            font-size: 16px;
            background: var(--tg-theme-secondary-bg-color, #16213e);
            color: var(--tg-theme-text-color, #eee);
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #667eea);
        }

        .password-field {
            position: relative;
        }

        .password-field input {
            padding-right: 100px;
        }

        .password-actions {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 4px;
        }

        .icon-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--tg-theme-text-color, #fff);
            font-size: 16px;
            cursor: pointer;
        }

        .strength-meter {
            height: 4px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 8px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0;
            transition: all 0.3s;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--tg-theme-hint-color, #888);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top-color: var(--tg-theme-button-color, #667eea);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #ff6b6b;
        }

        .toast {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: #2ecc71;
            color: #fff;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 100;
        }

        .toast.show {
            opacity: 1;
        }

        .toast.error {
            background: #ff6b6b;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>‚úèÔ∏è Parolni Tahrirlash</h2>

        <div id="content">
            <div class="loading">
                <div class="spinner"></div>
                <p>Yuklanmoqda...</p>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Saved!</div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();

        const API_BASE = 'https://bot.sanakulov.uz';
        const userId = tg.initDataUnsafe?.user?.id || 0;

        // Get service from URL params
        const urlParams = new URLSearchParams(window.location.search);
        const serviceName = urlParams.get('service') || '';

        let originalService = '';
        let passwordData = {};

        async function loadPassword() {
            if (!userId || !serviceName) {
                showError("Ma'lumot topilmadi");
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/password?user_id=${userId}&service=${encodeURIComponent(serviceName)}`);
                const data = await response.json();

                if (data.error === 'session_locked') {
                    showError("Session yopiq. /unlock qiling.");
                    return;
                }

                if (data.success) {
                    originalService = data.service;
                    passwordData = data;
                    renderForm(data);
                } else {
                    showError("Parol topilmadi");
                }
            } catch (error) {
                console.error(error);
                showError("Server xatosi");
            }
        }

        function renderForm(data) {
            // Parse data to extract login, password, note
            const lines = data.data.split('\n');
            let login = '', password = '', note = '';

            lines.forEach(line => {
                if (line.startsWith('Login:')) login = line.replace('Login:', '').trim();
                else if (line.startsWith('Pass:')) password = line.replace('Pass:', '').trim();
                else if (line.startsWith('Note:')) note = line.replace('Note:', '').trim();
                else if (!login && !password) password = line.trim(); // fallback for simple data
            });

            document.getElementById('content').innerHTML = `
                <form id="editForm">
                    <div class="form-group">
                        <label>Xizmat nomi</label>
                        <input type="text" id="service" value="${escapeHtml(data.service)}" required>
                    </div>

                    <div class="form-group">
                        <label>Login / Username</label>
                        <input type="text" id="login" value="${escapeHtml(login)}" placeholder="email@example.com">
                    </div>

                    <div class="form-group">
                        <label>Parol</label>
                        <div class="password-field">
                            <input type="text" id="password" value="${escapeHtml(password)}" required>
                            <div class="password-actions">
                                <button type="button" class="icon-btn" onclick="generatePassword()">üé≤</button>
                                <button type="button" class="icon-btn" onclick="copyPassword()">üìã</button>
                            </div>
                        </div>
                        <div class="strength-meter">
                            <div class="strength-bar" id="strengthBar"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Izoh</label>
                        <textarea id="note" rows="3" placeholder="Qo'shimcha ma'lumot...">${escapeHtml(note)}</textarea>
                    </div>
                </form>
            `;

            // Password strength
            document.getElementById('password').addEventListener('input', (e) => {
                updateStrength(e.target.value);
            });
            updateStrength(password);

            // Main button
            tg.MainButton.setText("üíæ Saqlash");
            tg.MainButton.show();
            tg.MainButton.onClick(savePassword);
        }

        function updateStrength(val) {
            let strength = 0;
            if (val.length > 5) strength += 20;
            if (val.length > 10) strength += 20;
            if (/[A-Z]/.test(val)) strength += 20;
            if (/[0-9]/.test(val)) strength += 20;
            if (/[^A-Za-z0-9]/.test(val)) strength += 20;

            const bar = document.getElementById('strengthBar');
            if (bar) {
                bar.style.width = strength + '%';
                if (strength < 40) bar.style.backgroundColor = '#ff6b6b';
                else if (strength < 80) bar.style.backgroundColor = '#ffa502';
                else bar.style.backgroundColor = '#2ecc71';
            }
        }

        function generatePassword() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let pass = "";
            for (let i = 0; i < 16; i++) {
                pass += chars[Math.floor(Math.random() * chars.length)];
            }
            document.getElementById('password').value = pass;
            updateStrength(pass);
        }

        function copyPassword() {
            const pass = document.getElementById('password').value;
            navigator.clipboard.writeText(pass).then(() => {
                showToast("‚úÖ Nusxa olindi!");
            });
        }

        async function savePassword() {
            const service = document.getElementById('service').value.trim();
            const login = document.getElementById('login').value.trim();
            const password = document.getElementById('password').value.trim();
            const note = document.getElementById('note').value.trim();

            if (!service || !password) {
                showToast("‚ùå Xizmat va parol majburiy!", true);
                return;
            }

            // Build data string
            let dataStr = "";
            if (login) dataStr += `Login: ${login}\n`;
            dataStr += `Pass: ${password}`;
            if (note) dataStr += `\nNote: ${note}`;

            try {
                tg.MainButton.showProgress();

                const response = await fetch(`${API_BASE}/api/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,
                        old_service: originalService,
                        new_service: service,
                        data: dataStr
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showToast("‚úÖ Saqlandi!");
                    setTimeout(() => tg.close(), 1000);
                } else {
                    showToast("‚ùå Xatolik!", true);
                }
            } catch (error) {
                showToast("‚ùå Server xatosi", true);
            } finally {
                tg.MainButton.hideProgress();
            }
        }

        function showError(msg) {
            document.getElementById('content').innerHTML = `
                <div class="error-state">
                    <p style="font-size: 48px; margin-bottom: 16px;">‚ö†Ô∏è</p>
                    <p>${msg}</p>
                </div>
            `;
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Init
        loadPassword();
    </script>
</body>

</html>